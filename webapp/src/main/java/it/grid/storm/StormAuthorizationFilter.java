package it.grid.storm;

import io.milton.http.XmlWriter;
import it.grid.storm.Configuration;
import it.grid.storm.authorization.AuthorizationFilter;
import it.grid.storm.authorization.Constants;
import it.grid.storm.authorization.StormAuthorizationUtils;
import it.grid.storm.authorization.UserCredentials;
import it.grid.storm.filetransfer.authorization.FileTransferAuthorizationFilter;
import it.grid.storm.storagearea.StorageArea;
import it.grid.storm.storagearea.StorageAreaManager;
import it.grid.storm.HttpHelper;
import it.grid.storm.webdav.authorization.WebDAVAuthorizationFilter;
import it.grid.storm.webdav.factory.StormResourceHelper;
import it.grid.storm.webdav.factory.exceptions.RuntimeApiException;
import it.grid.storm.xmlrpc.outputdata.PingOutputData;

import java.io.IOException;
import java.io.OutputStream;
import java.io.PrintWriter;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class StormAuthorizationFilter implements Filter {

	private static final Logger log = LoggerFactory.getLogger(StormAuthorizationFilter.class);
	private String favicon = "data:;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAABaCAYAAAA4qEECAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QjlFN0ZGNzkzRDU4MTFFMjhGMzdFM0M0QzkxNUFCNTUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QjlFN0ZGN0EzRDU4MTFFMjhGMzdFM0M0QzkxNUFCNTUiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpCOUU3RkY3NzNENTgxMUUyOEYzN0UzQzRDOTE1QUI1NSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpCOUU3RkY3ODNENTgxMUUyOEYzN0UzQzRDOTE1QUI1NSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PuWAy6IAADhxSURBVHja5H35d2VH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";
	
	private HttpHelper httpHelper;

	public void destroy() {
	}

	public void init(FilterConfig fc) throws ServletException {
		try {
			Configuration.stormBackendHostname = fc.getInitParameter("stormBackendHostname");
			Configuration.stormBackendPort = Integer.valueOf(fc.getInitParameter("stormBackendPort"));
			Configuration.stormBackendServicePort = Integer.valueOf(fc.getInitParameter("stormBackendServicePort"));
			Configuration.stormFrontendHostname = fc.getInitParameter("stormFrontendHostname");
			Configuration.stormFrontendPort = Integer.valueOf(fc.getInitParameter("stormFrontendPort"));
		} catch (Exception e) {
			log.error(e.getMessage());
			throw new ServletException(e.getMessage());
		}
		printConfiguration();
		/* Load Storage Area List */
		try {
			StorageAreaManager.init(Configuration.stormBackendHostname, Configuration.stormBackendServicePort);
		} catch (Exception e) {
			log.error(e.getMessage());
			throw new ServletException(e.getMessage());
		}
	}

	public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {

		httpHelper = new HttpHelper((HttpServletRequest) request, (HttpServletResponse) response);
		/* clear session */
		httpHelper.getRequest().getSession(true);
		httpHelper.getRequest().getSession().setAttribute("forced", false);
		
		log.debug("Requested-URI: " + httpHelper.getRequest().getRequestURI());

		if (httpHelper.getRequest().getRequestURI().equals("/favicon.ico")) {
			sendFavicon();
			return;
		}
		
		/* HERE THE CODE FOR OPTIONS ON ROOT DIR */
		if (isRootPath(httpHelper.getRequestStringURI())) {
			if (httpHelper.getRequestMethod().equals("OPTIONS")) {
				doPing();
				return;
			}
			if (httpHelper.getRequestMethod().equals("GET")) {
				sendRootPage();
				return;
			}
		}

		AuthorizationFilter filter;
		try {
			if (isFileTransferRequest(httpHelper.getRequest().getRequestURI())) {
				log.info("Received a file-transfer request");
				filter = new FileTransferAuthorizationFilter(httpHelper, Configuration.FILETRANSFER_CONTEXTPATH);
			} else {
				log.info("Received a webdav request");
				filter = new WebDAVAuthorizationFilter(httpHelper);
			}
		} catch (ServletException e) {
			log.error(e.getMessage());
			sendError(HttpServletResponse.SC_BAD_REQUEST, e.getMessage());
			return;
		}

		boolean isAuthorized = false;
		try {
			isAuthorized = filter.isUserAuthorized();
		} catch (ServletException e) {
			log.error(e.getMessage());
			sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, e.getMessage());
		}
		if (!isAuthorized) {
			log.warn("User is not authorized to access the requested resource");
			sendError(HttpServletResponse.SC_UNAUTHORIZED, "You are not authorized to access the requested resource");
			return;
		}
		log.info("User is authorized to access the requested resource");
		chain.doFilter(request, response);
	}

	private void sendFavicon() throws IOException {
		httpHelper.getResponse().setContentType("text/html");
		PrintWriter out;
		try {
			out = httpHelper.getResponse().getWriter();
		} catch (IOException e) {
			log.error("Unable to obtain the PrintWriter for the response. IOException: " + e.getMessage());
			throw e;
		}
		out.print(favicon);
	}

	private boolean isRootPath(String requestStringURI) {
		return (requestStringURI.isEmpty() || requestStringURI.equals("/"));
	}

	private boolean isFileTransferRequest(String requestedURI) {
		return requestedURI.startsWith("/fileTransfer");
	}

	private void sendError(int errorCode, String errorMessage) {
		try {
			httpHelper.getResponse().sendError(errorCode, errorMessage);
		} catch (IOException e) {
			log.error(e.getMessage());
			e.printStackTrace();
		}
	}

	private void printConfiguration() {
		log.debug("StoRM-Authorization-filter init-parameters' values:");
		log.debug(" - stormBackendHostname    : " + Configuration.stormBackendHostname);
		log.debug(" - stormBackendPort        : " + Configuration.stormBackendPort);
		log.debug(" - stormBackendServicePort : " + Configuration.stormBackendServicePort);
		log.debug(" - stormFrontendHostname   : " + Configuration.stormFrontendHostname);
		log.debug(" - stormFrontendPort       : " + Configuration.stormFrontendPort);
	}

	private void doPing() {
		// doPing
		log.info("ping " + Configuration.stormBackendHostname + ":" + Configuration.stormBackendPort);
		try {
			UserCredentials user = new UserCredentials(httpHelper);
			PingOutputData output = StormResourceHelper.doPing(Configuration.stormBackendHostname, Configuration.stormBackendPort, user);
			log.info(output.getBeOs());
			log.info(output.getBeVersion());
			log.info(output.getVersionInfo());
		} catch (RuntimeApiException e) {
			log.error(e.getMessage());
		}
	}

	private void sendRootPage() throws IOException {
		OutputStream out = httpHelper.getResponse().getOutputStream();
//		Content-Type: text/html; charset=iso-8859-1
		httpHelper.getResponse().addHeader("Content-Type", "text/html");
		XmlWriter w = new XmlWriter(out);
		w.writeText("<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">");
		w.begin("html").writeAtt("lang", "en").writeAtt("xmlns", "http://www.w3.org/1999/xhtml").open();
		w.open("head");
		w.begin("style").writeAtt("type", "text/css").open().writeText(getTableStyle()).close();
		w.close("head");
		w.open("body");
		w.begin("h1").open().writeText("StoRM Gridhttps-server WebDAV - /").close();
		w.open("table");
		w.open("tr");
		w.begin("td").open().begin("b").open().writeText("storage-area name").close().close();
		w.close("tr");
		UserCredentials user = new UserCredentials(httpHelper);
		for (StorageArea sa : StorageAreaManager.getInstance().getStorageAreas()) {
			if (!sa.getProtocolAsList().contains(httpHelper.getRequestProtocol())) {
				continue;
			}
			if (!isUserAuthorized(user, sa)) {
				continue;
			}
			w.open("tr");
			w.open("td");
			String name = sa.getStfnRoot().substring(1);
			// entry name-link
			String path = buildHref(sa.getStfnRoot(), "");
			w.begin("img").writeAtt("alt", "").writeAtt("src", getFolderIco()).open().close();
			w.begin("a").writeAtt("href", path).open().writeText(name).close();
			w.close("td");
			w.close("tr");
		}
		w.close("table");
		w.close("body");
		w.close("html");
		w.flush();
	}

	private boolean isUserAuthorized(UserCredentials user, StorageArea sa) {
		boolean response = false;
		try {
			response = StormAuthorizationUtils.isUserAuthorized(user, Constants.PREPARE_TO_GET_OPERATION, sa.getFSRoot());
		} catch (IllegalArgumentException e) {
			e.printStackTrace();
		} catch (Exception e) {
			e.printStackTrace();
		}
		return response;
	}

	private String getTableStyle() {
		String out = "table {width: 100%; font-family: Arial,\"Bitstream Vera Sans\",Helvetica,Verdana,sans-serif; color: #333;}";
		out += "table td, table th {color: #555;}";
		out += "table th {text-shadow: rgba(255, 255, 255, 0.796875) 0px 1px 0px; font-family: Georgia,\"Times New Roman\",\"Bitstream Charter\",Times,serif; font-weight: normal; padding: 7px 7px 8px; text-align: left; line-height: 1.3em; font-size: 14px;}";
		out += "table td {font-size: 12px; padding: 4px 7px 2px; vertical-align: top; }";
		out += "img {margin-right: 5px; margin-top: 0; vertical-align: bottom; width: 12px; }";
		return out;
	}

	private String getFolderIco() {
		String out = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAAGXcA1uAAAABGdBTUEAALGOfPtRkwAAACBjSFJNAAB6JQAAgIMAAPn/AACA6AAAdTAAAOpgAAA6lwAAF2+XqZnUAAACFklEQVR4nGL4//8/AwwDBBBDSkpKKRDvB2GAAAJxfIH4PwgDBBADsjKAAALJsMKUAQQQA0wJCAMEEIhTiCQwHYjngrQABBBIIgtZJQwDBBDYQCCjAIgbkLAmQACh2IiMAQII2cKtQDwbiDtAEgABBJNYB3MaFEcABBDMDgzLAQIIJKiPRaIOIIBgOpBd1AASAwggmEQ4SBU0tCJwuRSEAQIIpLgam91Y8CaQBoAAggVGCJGa/gMEEEhDCi4fYsGXAAII5odiIjVIAwQQTs/hwgABRLIGgAACOUcY6vEqIC4DYlF8GgACCJdnpwLxTGiimAPEFjANAAFEbOj8h2kACCCYhjwgTkdLUeh4A0gDQADBNGgRaVMpQACBNBwB4jYiNagDBBBIQwYQ3yLWHwABBNIgQIrHAQIIZ07Bgv+A1AIEEEyDUgpaZkHDebBgBQggkpMGQACRrIFUDBBAIOfLAvEbAv49B8Ss5FgAEEAgC+qIjQUi8F8gtke2ACCAQBZUICn4lwIpeX2AWAeINaC0FpQNwmpArIKEQRGoAMVyQCyJbAFAACGXFheAmAmIV1LRR+4AAQSyIBeIfwExHxDHUNFwEA4ACCCQBaBcPAWaXjdQ0fAfQMwCEEAgQxOB2AaIOYD4DxUtWAFyNEAAwSMDKBBJ5eAJAZkLEEDIFmgD8TcqGAxKqmUwcwECiOY5GSCAaG4BQIABAFbNMXYg1UnRAAAAAElFTkSuQmCC";
		return out;
	}

	private String buildHref(String uri, String name) {
		String abUrl = uri;
		if (!abUrl.endsWith("/")) {
			abUrl += "/";
		}
		return abUrl + name;
	}
}